---
apiVersion: v1
kind: Secret
metadata:
  name: gitlab-initial-root-password
  namespace: {{ instance_name }}-{{ tool_id }}
type: Opaque
stringData:
  password: changeme123
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: gitlab
  namespace: {{ instance_name }}-{{ tool_id }}
spec:
  interval: 10m
  url: http://charts.gitlab.io/
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: gitlab
  namespace: {{ instance_name }}-{{ tool_id }}
spec:
  interval: 10m
  releaseName: gitlab
  chart:
    spec:
      chart: gitlab
      version: 8.10.4
      sourceRef:
        kind: HelmRepository
        name: gitlab
  values:
    global:
      edition: ee
      gitlabVersion: "17.11.0"
      hosts:
        domain: {{ domain }}
        https: true
      ingress:
        enabled: true
        configureCertmanager: true
        provider: nginx
        path: /
      initialRootPassword:
        secret: gitlab-initial-root-password
        key: password
      storage:
        dynamic:
          storageClass: ""
      minio:
        enabled: false
      appConfig:
        enableUsagePing: true
        enableSeatLink: true
        lfs:
          enabled: false
          proxy_download: true
          bucket: git-lfs
          connection: {}
        artifacts:
          enabled: false
          proxy_download: true
          bucket: gitlab-artifacts
          connection: {}
        uploads:
          enabled: false
          proxy_download: true
          bucket: gitlab-uploads
          connection: {}
        packages:
          enabled: false
          proxy_download: true
          bucket: gitlab-packages
          connection: {}
        object_store:
          enabled: false
          proxy_download: false #was true
          connection: {}
      gitaly:
        enabled: true
        authToken: {}
        persistence:
          enabled: true
          size: 10Gi
          storageClass: ""
      praefect:
        enabled: false
      redis:
        install: true
        auth:
          enabled: true
        sentinelAuth:
          enabled: false
        master:
          persistence:
            enabled: true
            size: 4Gi
            storageClass: ""
      psql:
        password: {}
      kas:
        enabled: true
        service:
          apiExternalPort: 8153
        tls:
          enabled: false
          verify: true
      registry:
        enabled: false
        host: registry.{{ domain }}
        bucket: registry
        tls:
          enabled: false
      pages:
        enabled: false
      smtp:
        enabled: false
      shared-secrets:
        enabled: true
      prometheus:
        install: false
      zoekt:
        gateway:
          basicAuth:
            enabled: true
            secretName: gitlab-zoekt-basic-auth
        indexer:
          internalApi:
            enabled: true
            secretName: gitlab-zoekt-basic-auth
            secretKey: zoekt-internal-api-secret
            gitlabUrl: https://{{ domain }}
    nginx-ingress:
      enabled: true
    certmanager-issuer:    
      email: admin@example.com
    postgresql:
      install: true
      persistence:
        enabled: true
        size: 8Gi
        storageClass: ""
      metrics:
        enabled: true
    redis:
      install: true
      master:
        persistence:
          enabled: true
          size: 4Gi
          storageClass: ""
    gitaly:
      persistence:
        enabled: true
        size: 10Gi
        storageClass: ""
    shared-secrets:
      enabled: true
    prometheus:
      install: true
    registry:
      enabled: true
    kas:
      enabled: false
    gitlab:
      migrations:
        enabled: false
      sidekiq:
        enabled: false
      toolbox:
        enabled: true
        backups:
          objectStorage:
            config:
              secret: fake-empty-secret
              key: connection
      webservice:
        enabled: true
      gitlab-shell:
        enabled: true
    pages:
      enabled: false
    spamcheck:
      enabled: false
    praefect:
      enabled: false
    gitlab-runner:
      install: true
      runners:
        locked: false
        secret: "nonempty"
        config: |
          [[runners]]
            [runners.kubernetes]
            image = "ubuntu:22.04"
